/**
 * @file userTable 管理员用户列表
 * @author zenguanming
 */

define(['jquery', 'underscore'], function ($, _) {

    require('interact');

    // template
    var item = '<span data-id="<%-uid%>" style="left: <%-x%>px; top:<%-y%>px;" class="drop-item draggable drag-drop">'
            +      '<%-username%>'
            +  '</span>';

    // 容器间距
    var INTERVAL = {
        other: 0,
        biu: 322,
        nc: 644
    };

    // 记录每个角色中用户的位置信息
    var pos = {
        other: [],
        biu: [],
        nc: []
    };

    // 用户位置的起始坐标
    var begin = {
        x: 25,
        y: 25
    };

    // 递增量
    var every = {
        x: 100,
        y: 35
    };

    function request(container, url) {
        $.ajax({
            url: url,
            type: 'POST',
            dataType: 'json'
        }).done(function (r) {
            if (r.status === 0) {
                var html = '';
                var data = r.data;
                var tmpl = _.template(item);

                var ret = [].concat(posReady(data.other.otherList, 'other'),
                                posReady(data.biu.biuList, 'biu'),
                                posReady(data.nc.ncList, 'nc'));
                for (var i = 0, len = ret.length; i < len; i++) {
                    html += tmpl(ret[i]);
                }

                $(container).prepend(html);

            }else {
                alert('加载用户列表出错。');
            }

        });
    }


    /**
     * 返回计算后的元素位置
     * @param {Array} data 元素数据
     * @param {string} name 容器名
     * @return {Object} 元素信息
     */
    function posReady(data, name) {
        var iVal = INTERVAL[name];
        var x = begin.x;
        var y = begin.y;
        var mPos = [];
        for (var i = 0, len = data.length; i < len; i++) {
            var row = Math.floor(i / 3);
            var col = i % 3;
            var pos = getPos(x + iVal, y, row, col);
            mPos.push($.extend(data[i], pos));
        }
        return mPos;
    }

    /**
     * 获取某行某列的元素坐标（序号从0开始）
     * @param {integer} beginX 起始x坐标
     * @param {integer} beginY 起始y坐标
     * @param {integer} rowNum 元素所在行号
     * @param {integer} colNum 元素所在列号
     * @return {Object} x和y坐标值
     */
    function getPos(beginX, beginY, rowNum, colNum) {
        return {
            x: beginX + colNum * every.x,
            y: beginY + rowNum * every.y
        };
    }

    return {
        init: function (container, ajaxUrl) {
            request(container, ajaxUrl);

        }
    };
});

