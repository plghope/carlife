/**
 * @file 注册数据表单
 * @author zengguanming
 *
 */

define(['jquery', 'underscore'], function ($, _) {

    require('datatables');
    require('select2');

    var dialog = require('dialog');

    var aclCache = {};

    // request url
    var DATA_URL_USER_LIST = '/bde/api/userlist';
    var DATA_URL_ACL_LIST = '/bde/api/acllist';
    var DATA_URL_ACL_DETAIL = '/bde/api/acldetail';
    var DATA_URL_ADD_DATA = '/bde/api/adddata';

    // template
    var TMPL_SELECT_SELECTOR = '#tmpl-select';
    var TMPL_TABLE_SELECTOR = '#tmpl-table';


    function getTmpl(selector) {
        return $(selector).html();
    }

    function getSelectContent(data) {
        var ret = '';
        for (var i = 0, len = data.length;i < len;i++) {
            ret += '<option value="' + data[i]['uid'] + '">' + data[i]['username'] + '</option>';
        }

        return ret;

    }

    function listenAclChange(){
        var priviledgeName = function (read, write, both, pos) {
            var mid = read + write;
            var end = mid + both;

            if (pos < read) {
                return '读';
            }else if (read <= pos && pos < mid) {
                return '写';
            }else if (mid <= pos && pos < end) {
                return '读写';
            }
        };

        var $pTable = null;

        $('#acl_id').on('change', function (e) {
            $.ajax({
                url: DATA_URL_ACL_DETAIL,
                type: 'POST',
                dataType: 'json',
                data: {
                    'acl_id': $(e.target).val()
                }
            }).done(function (r) {
                if (r.status === 0) {
                    var data = r.data;
                    var read = data.read ? data.read : [];
                    var write = data.write ? data.write : [];
                    var both = data.both ? data.both : [];
                    var list = [].concat(read, write, both);
                    var rLength = read.length;
                    var wLength = write.length;
                    var bLength = both.length;
                    var tmpl = _.template($('#tmpl-table').html());
                    var ret = '';

                    for (var i = 0, len = list.length;i < len;i++) {
                        var tmp = list[i];
                        var priviledge = priviledgeName(rLength, wLength, bLength, i);
                        ret += '<tr>'
                            +      '<td>' + tmp['username'] + '</td>'
                            +      '<td>' + tmp['role_user_type'] + '</td>'
                            +      '<td>' + priviledge + '</td>'
                            +  '</tr>';
                    }

                    if ($pTable) {
                        $pTable.remove();
                    }

                    $('#form-body').append(tmpl({
                        content: ret
                    }));

                    $pTable = $('#priviledge-table');
                    $('table', $pTable).dataTable({
                        searching: false,
                        info: false,
                        language: {
                            zeroRecords: '没有找到数据',
                            lengthMenu: '每页展示 _MENU_ 条数据',
                            paginate: {
                                first: '第一页',
                                previous: '上一页',
                                next: '下一页',
                                last: '最后一页'
                            }

                        }
                    });

                }

            });

        }).trigger('change');
    }

    function aclInit(update){
        $.ajax({
            url: DATA_URL_ACL_LIST,
            type: 'POST',
            dataType: 'json'
        }).done(function (r) {
            if (r.status === 0) {
                var data = r.data;
                var ret = '';
                for (var i = 0, len = data.length;i < len;i++) {
                    var tmp = data[i];
                    ret += '<option value="' + tmp['id'] + '">' + tmp['name'] + '</option>';
                    aclCache[tmp['id']] = tmp;
                }

                $('#acl_id')
                    .html(ret)
                    .select2();
                
                if (!update){
                    listenAclChange();
                }


            }
        });
    }

    function userInit() {
        $.ajax({
            url: DATA_URL_USER_LIST,
            type: 'POST',
            dataType: 'json'
        }).done(function (r) {
            if (r.status === 0) {
                var data = r.data;
                var tmpl  = _.template(getTmpl(TMPL_SELECT_SELECTOR));
                var result = tmpl({
                    biu: getSelectContent(data.biu.biuList),
                    nc: getSelectContent(data.nc.ncList)
                });

                $('#owner_uid')
                    .html(result)
                    .select2();

            }
        });
    }

    function request() {
        userInit();
        aclInit();
    }


    function registerHandler() {
        $('#data-form').on('submit', function (e) {
            var $input = $('input[name="data_name"]');
            var $button = $('#b-register-data');

            if ($input.val() === '') {
                $input.next('.help-block').text('数据集名称不能为空');
            }else {
                var ret = $(this).serialize();
                $.ajax({
                    url: DATA_URL_ADD_DATA,
                    type: 'POST',
                    dataType: 'json',
                    data: ret
                }).done(function (r) {
                    if (r.status === 0) {
                        $button.next('.help-block').text('注册成功');

                    }else {
                        $button.next('.help-block').text('注册失败');
                    }

                    $button.prop('disabled', false);

                }).fail(function () {
                    $button.next('.help-block').text('注册失败');
                    $button.prop('disabled', false);
                });

                $button.prop('disabled', true);
            }

            e.preventDefault();

        });
    }

    return {
        init: function () {
            request();
            registerHandler();
        },
        refreshAcl: function(){

            aclInit(true);
        }
    };
});
